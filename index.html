<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://js.arcgis.com/4.17/esri/css/main.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/json2csv@4.2.1"></script>
    <script src="https://js.arcgis.com/4.17/"></script>
    
    <title>AGSL Nautical Chart Explorer</title>
    <style>
      #viewDiv {
        position: absolute;
        top: 0;
        bottom: 0;
        margin-top: 56px;
        width: 100%;
      }
      .navbar {
        height: 56.5px;        
        
      }
      .bg-light {
        background: #555555 !important;
        border-bottom: solid 2px black;
      }
    </style>
    <script>
  // Function to download the GeoJSON object from the REST API    
  function downloadGeoJson(text, name) {
    var a = document.createElement('a');
    var type = name.split(".").pop();
    a.href = URL.createObjectURL( new Blob([text], { type:`text/${type === "txt" ? "plain" : type}` }) );
    a.download = name;
    a.click();
  }    

  // AGOL API JS
  require([
    "esri/Map", 
    "esri/views/MapView",
    "esri/layers/FeatureLayer", 
    "esri/geometry/Extent",
    "esri/smartMapping/statistics/uniqueValues"
    ], function(Map, MapView, FeatureLayer, Extent, uniqueValues){
  // Create a style for the chartsLayer
  var renderer = {
  type: "simple",  // autocasts as new SimpleRenderer()
  symbol: {
    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
    color: [ 255, 128, 0, 0.5 ],
    outline: {  // autocasts as new SimpleLineSymbol()
      width: 1,
      color: "white"
    }
  }
  };

  // Create a FeatureLayer
  var chartsLayer = new FeatureLayer({
    url: "https://webgis.uwm.edu/arcgisuwm/rest/services/AGSL/agsl_nautical/MapServer/0",
    outFields: ["*"], // Return all fields so it can be queried client-side
    renderer: renderer
  });

  // Create the Map and add the featureLayer defined above
  map = new Map({
    basemap: "oceans",
    layers: [chartsLayer]
  });

  // Create the MapView
  var view = new MapView({
    container: "viewDiv",
    map: map,
    center: [0,0],    
    zoom: 3
  });

  // setup the contraints of the map
  view.constraints = {
  geometry: {            // Constrain lateral movement to the entire globe with no repeat
    type: "extent",
    xmin: -90,
    ymin: -180,
    xmax: 90,
    ymax: 180
  },
  minZoom: 2,          
  rotationEnabled: false // Disables map rotation
  };

uniqueValues({
  layer: chartsLayer,
  field: "setTitle"
}).then(function(response){
  // prints each unique value and the count of features containing that value
  var infos = response.uniqueValueInfos;
  infos.forEach(function(info){
    console.log("CANDIDATE: ", info.value, " # OF CAMPAIGN STOPS: ", info.count);
  });
});

var query = chartsLayer.createQuery({returnDistinctValues: true});
query.where = '1=1';
query.outFields = [ "setTitle" ];

chartsLayer.queryFeatures(query)
  .then(function(response){
    console.log(response);
     // returns a feature set with features containing the following attributes
     // STATE_NAME, COUNTY_NAME, POPULATION, POP_DENSITY
   });
  // Create a template for the popup
  var template = {
  // autocasts as new PopupTemplate()
  title: "<font color='#008000'>{title}",
  content: [     
        {
      type: "media",
      mediaInfos: [
        {
          title: "Camera is online:",
          type: "image",
          value: {sourceURL: '{iiifURL}'}
        }
      ]          
        },{
      type: "fields",
      fieldInfos: [
        {
          fieldName: "label",
          label: "label"
        },
        {
          fieldName: "west",
          label: "West"
        },
        {
          fieldName: "east",
          label: "East"
        },
        {
          fieldName: "north",
          label: "North"
        },
        {
          fieldName: "south",
          label: "South"
        },
        {
          fieldName: "scale",
          label: "Scale"
        }
      ]
    }, 
  ]
};

// Set the popup template on the layer
chartsLayer.popupTemplate = template;

function setFeatureLayerFilter(expression) {
  chartsLayer.definitionExpression = expression;
}
// The filter for the page load map view
// Only show small scale series
setFeatureLayerFilter("Shape_Area >= 9463642202000" );

//setFeatureLayerFilter("scale < 698000" );
// Exclude map scales according to the zoom level
// Use 'Shape_Area' because scale information might be missing for some charts     
view.watch("zoom", function(newValue) {
  if (newValue <= 2) {    
    setFeatureLayerFilter("Shape_Area >= 9463642202000" ); 
  } else if (newValue >= 4) {
    setFeatureLayerFilter("Shape_Area <= 946364220200" );
  }

  console.log("scale property changed: ", newValue);
});

// Query the layer based on the chart series
var sqlExpressions = [
  "datePub = 1911",
  "datePub = 1912"  
];

var selectFilter = document.createElement("select");
selectFilter.setAttribute("class", "esri-widget esri-select");
selectFilter.setAttribute(
  "style",
  "width: 275px; font-family: Avenir Next W00; font-size: 1em;"
);

sqlExpressions.forEach(function (sql) {
  var option = document.createElement("option");
  option.value = sql;
  option.innerHTML = sql;
  selectFilter.appendChild(option);
});

view.ui.add(selectFilter, "top-right");

 selectFilter.addEventListener('change', function (event) {
        setFeatureLayerFilter(event.target.value);
  });

// Add element for the download button using Esri widgets
var downloadBtn = document.createElement('div');
downloadBtn.className = "esri-icon-download esri-widget--button esri-widget esri-interactive";
downloadBtn.addEventListener('click', function(event){
  // when the download button is clicked show the modal
  $('#dataModal').modal('show') 
})

view.ui.add(downloadBtn, "top-left");

var download = document.getElementById('download');


getDataBtn.addEventListener('click', function(event){ 
  var seriesVal = document.getElementById('series').value;
var dataFormat = document.getElementById('format').value;
  console.log(seriesVal, dataFormat);
  if (dataFormat == 'csv') {  
// Get the charts data from the ArcGIS REST API
// Use an HTTP get request
    $.ajax({
            dataType: 'json',
            url: 'http://webgis.uwm.edu/arcgisuwm/rest/services/AGSL/agsl_nautical/MapServer/0/query?where=setTitle+%3D+%27' + seriesVal + '%27&text=&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&distance=&units=esriSRUnit_Foot&relationParam=&outFields=*&returnGeometry=true&returnTrueCurves=false&maxAllowableOffset=&geometryPrecision=&outSR=&havingClause=&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&historicMoment=&returnDistinctValues=false&resultOffset=&resultRecordCount=&returnExtentOnly=false&datumTransformation=&parameterValues=&rangeValues=&quantizationParameters=&featureEncoding=esriDefault&f=pjson',
            type: "GET",    
            success: function(data) {            
              // The output fields for the CSV, if new ones are added must add here           
              var fields = [            
                {
                  label: 'label', 
                  value: 'attributes.label',
                  default: 'NULL' 
                },
                {
                  label: 'title', 
                  value: 'attributes.title',
                  default: 'NULL' 
                },
                {
                  label: 'datePub', 
                  value: 'attributes.datePub',
                  default: 'NULL' 
                },
                {
                  label: 'scale', 
                  value: 'attributes.scale',
                  default: 'NULL' 
                },
                {
                  label: 'primeMer', 
                  value: 'attributes.primeMer',
                  default: 'NULL' 
                },
                {
                  label: 'west', 
                  value: 'attributes.west',
                  default: 'NULL' 
                },
                {
                  label: 'east', 
                  value: 'attributes.east',
                  default: 'NULL' 
                },
                 {
                  label: 'north', 
                  value: 'attributes.north',
                  default: 'NULL' 
                },
                 {
                  label: 'south', 
                  value: 'attributes.south',
                  default: 'NULL' 
                },
                {
                  label: 'color', 
                  value: 'attributes.color',
                  default: 'NULL' 
                },
                 {
                  label: 'available', 
                  value: 'attributes.available',
                  default: 'NULL' 
                },
                 {
                  label: 'physHold', 
                  value: 'attributes.physHold',
                  default: 'NULL' 
                },
                {
                  label: 'edition', 
                  value: 'attributes.edition',
                  default: 'NULL' 
                },
                {
                  label: 'publisher', 
                  value: 'attributes.projection',
                  default: 'NULL' 
                },
                {
                  label: 'projection', 
                  value: 'attributes.projection',
                  default: 'NULL' 
                },
                {
                  label: 'location', 
                  value: 'attributes.location',
                  default: 'NULL' 
                },
                {
                  label: 'digHold', 
                  value: 'attributes.digHold',
                  default: 'NULL' 
                },
                {
                  label: 'bathInterv', 
                  value: 'attributes.bathInterv',
                  default: 'NULL' 
                },
                {
                  label: 'bathLines', 
                  value: 'attributes.bathLines',
                  default: 'NULL' 
                },
                {
                  label: 'note', 
                  value: 'attributes.note',
                  default: 'NULL' 
                },
                {
                  label: 'recId', 
                  value: 'attributes.recId',
                  default: 'NULL' 
                },
                {
                  label: 'iiifUrl', 
                  value: 'attributes.iiifURL',
                  default: 'NULL' 
                },
              ]             
              var parser = new json2csv.Parser({fields});            
              var csv = parser.parse(data.features);
              var element = document.createElement('a');
              element.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
              element.target = '_blank';
              element.download = 'chart_data.csv';
              element.click();            
            }
    });
  } else if (dataFormat == 'geojson') {
    $.ajax({
          dataType: 'json',
          url: 'http://webgis.uwm.edu/arcgisuwm/rest/services/AGSL/agsl_nautical/MapServer/0/query?where=setTitle+%3D+%27' + seriesVal + '%27&text=&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&distance=&units=esriSRUnit_Foot&relationParam=&outFields=*&returnGeometry=true&returnTrueCurves=false&maxAllowableOffset=&geometryPrecision=&outSR=&havingClause=&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&historicMoment=&returnDistinctValues=false&resultOffset=&resultRecordCount=&returnExtentOnly=false&datumTransformation=&parameterValues=&rangeValues=&quantizationParameters=&featureEncoding=esriDefault&f=geojson',
          type: "GET",    
          success: function(data) {            
            downloadGeoJson(JSON.stringify(data, undefined, 4), 'chart_data.geojson');           
          }
    });   
  }
})

})

  </script>
    </script>
  </head>
  <body>
    <!-- Image and text -->
<nav class="navbar navbar-light bg-light">
  <a class="navbar-brand" href="#">
    <img src="compass.png" width="40" height="40" class="d-inline-block align-top" alt="" loading="lazy">
    AGSL Nautical Chart Explorer
  </a>
</nav>
    <div id="viewDiv"></div>
    <div class="modal" id="dataModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Download Chart Data</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <label for="cars">Chart series:</label>
        <select name="series" id="series">         
            <option value="French Charts">French Charts</option>
            <option value="Null Island Charts">Null Island Charts</option>              
        </select>
         <label for="cars">Format:</label>
        <select name="format" id="format">         
            <option value="csv">CSV</option>
            <option value="geojson">GeoJSON</option>              
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" id="getDataBtn" class="btn btn-primary">Download</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
  </body>
</html>